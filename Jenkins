pipeline {
    agent any
    parameters {
        string(name: 'Ip', defaultValue: 'localhost', description: 'Ip or dnsname instance')
        string(name: 'User', defaultValue: 'user', description: 'Enter username for ssh')
        string(name: 'Password', defaultValue: 'password', description: 'Enter password for ssh')
        string(name: 'sshkey', defaultValue: 'empty', description: 'Enter key for ssh')

    }
    stages {
        stage ('Connect to instance') {
            steps {
              if (${params.Password} != 'password') {
                sh 'ssh ${params.User}@${params.Ip}'
            } else {
                sh 'mkdir ~/.ssh'
                sh 'touch ~/.ssh/key.pem'
                sh 'echo "${params.sshkey}" | tr -d "\r" > ~/.ssh/key.pem'
                sh 'chmod 700 ~/.ssh'
                sh 'chmod 600 ~/.ssh/key.pem'
                sh 'ssh -i ~/.ssh/key.pem ${params.User}@${params.Ip}'
                sh 'yes'
            }
                sh 'su -'
                sh 'apt update -y'
                sh 'apt install nodejs -y'
                echo "Done"
            }
        }

        stage ('Build'){
            steps{
                print 'Hello'
                print 'world'
            }
        }

        stage ('Test'){
            steps{
                print 'Hello'
                print 'world'
            }
        }

        stage ('Deploy'){
            steps{
                print 'Hello'
                print 'world'
            }
        }
    }
}
